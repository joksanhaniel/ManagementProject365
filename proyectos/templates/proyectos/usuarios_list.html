{% extends 'proyectos/base.html' %}

{% block title %}Usuarios - MultiProject Pro{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-6">
        <h2><i class="bi bi-people-fill"></i> Usuarios del Sistema</h2>
        <p class="text-muted">Gestión de usuarios y roles</p>
    </div>
    <div class="col-md-6 text-end">
        {% if es_trial %}
            <button class="btn btn-secondary" disabled title="No disponible durante el trial">
                <i class="bi bi-lock-fill"></i> Nuevo Usuario (Trial)
            </button>
        {% else %}
            <a href="{% url 'usuario_create' empresa_codigo %}" class="btn btn-primary">
                <i class="bi bi-person-plus-fill"></i> Nuevo Usuario
            </a>
        {% endif %}
    </div>
</div>

{% if es_trial %}
<div class="alert alert-warning mb-3">
    <i class="bi bi-info-circle-fill"></i>
    <strong>Limitación del Trial:</strong> Durante el período de prueba solo puedes tener 1 usuario (el administrador creado en el registro).
    <a href="{% url 'renovar_licencia' empresa_codigo %}" class="alert-link">Suscríbete a un plan</a> para crear usuarios ilimitados.
</div>
{% endif %}

<!-- Filtros -->
<div class="card mb-3">
    <div class="card-body">
        <form method="get" class="row g-3">
            <div class="col-md-4">
                <label class="form-label">Rol</label>
                <select name="rol" class="form-select">
                    <option value="">Todos los roles</option>
                    {% for rol_val, rol_label in roles %}
                        <option value="{{ rol_val }}" {% if filtro_rol == rol_val %}selected{% endif %}>
                            {{ rol_label }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label">Estado</label>
                <select name="is_active" class="form-select">
                    <option value="">Todos</option>
                    <option value="1" {% if filtro_is_active == '1' %}selected{% endif %}>Activo</option>
                    <option value="0" {% if filtro_is_active == '0' %}selected{% endif %}>Inactivo</option>
                </select>
            </div>
            <div class="col-md-4 d-flex align-items-end">
                <button type="submit" class="btn btn-primary me-2">
                    <i class="bi bi-funnel"></i> Filtrar
                </button>
                <a href="{% url 'usuarios_list' empresa_codigo %}" class="btn btn-secondary">
                    <i class="bi bi-x-circle"></i> Limpiar
                </a>
            </div>
        </form>
    </div>
</div>

<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Usuario</th>
                        <th>Nombre Completo</th>
                        <th>Email</th>
                        <th>Empresa</th>
                        <th>Rol</th>
                        <th>Estado</th>
                        <th>Último Acceso</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for usuario in usuarios %}
                    <tr>
                        <td><strong>{{ usuario.username }}</strong></td>
                        <td>{{ usuario.first_name }} {{ usuario.last_name }}</td>
                        <td>{{ usuario.email|default:"-" }}</td>
                        <td>
                            {% if usuario.empresa %}
                                <span class="badge bg-info">{{ usuario.empresa.codigo }}</span>
                                <small class="text-muted d-block">{{ usuario.empresa.nombre }}</small>
                            {% else %}
                                <span class="badge bg-secondary">Sin empresa</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if usuario.is_superuser %}
                                <span class="badge bg-danger"><i class="bi bi-star-fill"></i> Superusuario</span>
                            {% elif usuario.rol == 'gerente' %}
                                <span class="badge bg-primary">{{ usuario.get_rol_display }}</span>
                            {% elif usuario.rol == 'supervisor' %}
                                <span class="badge bg-warning">{{ usuario.get_rol_display }}</span>
                            {% elif usuario.rol == 'contador' %}
                                <span class="badge bg-success">{{ usuario.get_rol_display }}</span>
                            {% elif usuario.rol == 'auxiliar' %}
                                <span class="badge bg-info">{{ usuario.get_rol_display }}</span>
                            {% elif usuario.rol == 'operador' %}
                                <span class="badge bg-dark">{{ usuario.get_rol_display }}</span>
                            {% else %}
                                <span class="badge bg-secondary">{{ usuario.get_rol_display }}</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if usuario.is_active %}
                                <span class="badge bg-success">Activo</span>
                            {% else %}
                                <span class="badge bg-secondary">Inactivo</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if usuario.last_login %}
                                {{ usuario.last_login|date:"d/m/Y H:i" }}
                            {% else %}
                                <span class="text-muted">Nunca</span>
                            {% endif %}
                        </td>
                        <td class="table-actions">
                            <a href="{% url 'usuario_update' empresa_codigo usuario.id %}" class="btn btn-sm btn-warning" title="Editar">
                                <i class="bi bi-pencil"></i>
                            </a>
                            <a href="{% url 'usuario_delete' empresa_codigo usuario.id %}" class="btn btn-sm btn-danger" title="Eliminar">
                                <i class="bi bi-trash"></i>
                            </a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="8" class="text-center text-muted">
                            No hay usuarios registrados
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Información sobre roles -->
<div class="card mt-3">
    <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-info-circle"></i> Descripción de Roles y Módulos de Acceso</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <!-- Columna Izquierda -->
            <div class="col-md-6">
                {% if user.is_superuser %}
                <h6><span class="badge bg-danger"><i class="bi bi-star-fill"></i> Superusuario</span></h6>
                <ul class="small">
                    <li>Acceso total al sistema</li>
                    <li>Gestión de empresas (multiempresa)</li>
                    <li>Gestión de usuarios de todas las empresas</li>
                    <li>Acceso al panel de administración Django</li>
                    <li>Puede cambiar entre empresas</li>
                </ul>
                <p class="small mb-3"><strong>Módulos:</strong> Dashboard, Clientes, Proveedores, Empleados, Proyectos, Planillas, Gastos, Usuarios, Empresas, Administración, API REST</p>
                {% endif %}

                <h6><span class="badge bg-primary">Gerente</span></h6>
                <ul class="small">
                    <li>Acceso total a la aplicación web (sin Django Admin)</li>
                    <li>Gestión de usuarios de su empresa</li>
                    <li>Crear/editar/eliminar proyectos</li>
                    <li>Gestionar empleados, asignaciones, planillas y gastos</li>
                    <li>Acceso completo a información financiera</li>
                </ul>
                <p class="small mb-3"><strong>Módulos:</strong> Dashboard, Clientes, Proveedores, Empleados, Proyectos, Planillas, Gastos, Maquinaria, Usos de Maquinaria, Usuarios</p>

                <h6><span class="badge bg-warning">Supervisor</span></h6>
                <ul class="small">
                    <li>Gestión de proyectos</li>
                    <li>Gestionar empleados y asignaciones</li>
                    <li>Gestionar planillas y gastos</li>
                    <li>Acceso a información financiera</li>
                    <li>Registro de asistencias</li>
                </ul>
                <p class="small mb-3"><strong>Módulos:</strong> Dashboard, Clientes, Proveedores, Empleados, Proyectos, Planillas, Gastos</p>
            </div>

            <!-- Columna Derecha -->
            <div class="col-md-6">
                <h6><span class="badge bg-success">Contador</span></h6>
                <ul class="small">
                    <li>Acceso a información financiera</li>
                    <li>Gestionar planillas de pago</li>
                    <li>Gestionar gastos del proyecto</li>
                    <li>Generar reportes financieros</li>
                    <li>Consultar proyectos (solo lectura)</li>
                </ul>
                <p class="small mb-3"><strong>Módulos:</strong> Dashboard, Proyectos (lectura), Planillas, Gastos</p>

                <h6><span class="badge bg-info">Auxiliar</span></h6>
                <ul class="small">
                    <li>Gestión de asignaciones de empleados</li>
                    <li>Consultar información de proyectos</li>
                    <li>Registro de asistencias</li>
                    <li>Sin acceso a información financiera</li>
                </ul>
                <p class="small mb-3"><strong>Módulos:</strong> Dashboard, Empleados, Proyectos (lectura)</p>

                <h6><span class="badge bg-dark">Operador</span></h6>
                <ul class="small">
                    <li>Gestionar gastos del proyecto</li>
                    <li>Gestionar maquinaria y equipo</li>
                    <li>Registrar uso de maquinaria</li>
                    <li>Puede ser asignado como operador en usos</li>
                    <li>Sin acceso a información financiera ni planillas</li>
                </ul>
                <p class="small mb-3"><strong>Módulos:</strong> Dashboard, Gastos, Maquinaria, Usos de Maquinaria</p>

                <h6><span class="badge bg-secondary">Usuario</span></h6>
                <ul class="small">
                    <li>Solo lectura de proyectos</li>
                    <li>Consultar reportes básicos</li>
                    <li>Sin permisos de escritura</li>
                    <li>Sin acceso a información financiera</li>
                </ul>
                <p class="small mb-3"><strong>Módulos:</strong> Dashboard, Proyectos (solo lectura)</p>
            </div>
        </div>

    </div>
</div>
{% endblock %}
